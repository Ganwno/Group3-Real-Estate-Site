<%
#   Created: Daniel Swain
#   Date: 06/04/2016
#   
#   Partial erb used by the manage page.
#   
#   This represents a property that will be manigable by the user, it might be rendered multiple times
#   
#   Collections
#   	@listings: The collection of listing objects from the database. Access properties using the database column names as listed in /app/models/listing.rb
#   
#   Todo:
#   	* Prompt/Dialog/Modal for the delete button
#   	* Style the property features (beds/baths...)
#   	* Handle what happens when there's no status (i.e. creating a status for a listing)
#   	
 %>

<% # A property listing management card. %>
<% @listings.each do |listing| %>
	<div class="ui fluid card">
		<div class="content">
			<% # Header containing address and edit listing button %>
			<div class="header">
				<div class="ui two column grid">
					<% # The address %>
					<div class="ui left floated left aligned ten wide column">
						<h2><%= "#{listing.ListingAddress}, #{listing.ListingSuburb}, #{listing.ListingState} #{listing.ListingPostCode}" %></h2>
					</div>

					<% # The Edit listing Button %>
					<div class="ui right floated right aligned six wide column">
						<%= link_to edit_sell_path(listing.ListingID), class: "ui small right labeled icon button sell-red-button" do  %>
							<%= content_tag(:i, "", class: "write icon") %>
							Edit Listing
						<% end %>
					</div>
				</div>
			</div>

			<% # The property listing body %>
			<div class="description">
				<div class="ui three column centered grid">
					<% # Property main listing image %>
					<div class="four wide column">
						<div class="ui image">
							<% # Get the main image path using our sell_helper.rb method listing_get_main_image(listing) %>
							<%= image_tag listing_get_main_image(listing).ListingImagePath, class: "ui centered medium image" %>

							<% # Status ribbon, clicking this will open the edit modal. %>
							<% if listing_get_status_object(listing) %>
								<% # If there is a status then we do this %>
								<% status_object = listing_get_status_object(listing) %>
								<% # Done in a content tag so I can send data information that is needed via the javascript function %>
								<%= content_tag :div, class: "ui label sell-red-ribbon manage-status ribbon", id: "launch-modal-#{listing.ListingID}", 
									onclick:"set_up_and_launch_modal(#{listing.ListingID})", data: {listing: listing.ListingID, 
										label: status_object.ListingStatusLabel,
										date: listing_get_status_date_readable(listing),
										start: listing_get_status_start_time_readable(listing),
										end: listing_get_status_end_time_readable(listing)} do %>
									<%= listing_get_status_readable(listing) %>
									<div class="detail"><i class="write icon"></i></div>
								<% end %>
							<% else %>
								<% # There's no status object for this listing, set a blank ribbon %>
								<%= content_tag :div, class: "ui label sell-red-ribbon manage-status ribbon", id: "launch-modal-#{listing.ListingID}", 
									onclick:"set_up_and_launch_modal(#{listing.ListingID})", data: {listing: listing.ListingID, 
										label: status_object.ListingStatusLabel,
										date: listing_get_status_date_readable(listing),
										start: listing_get_status_start_time_readable(listing),
										end: listing_get_status_end_time_readable(listing)} do %>
									Add a status for this listing
									<div class="detail"><i class="write icon"></i></div>
								<% end %>
							<% end %>
						</div>
					</div>
					
					<% # Description and information block %>
					<div class="nine wide column">
						<% # The Description %>
						<p><b>Description: </b><%= listing.ListingDescription %></p>

						<% # The bottom info bar showing views, comments, favourites and expiry %>
						<div class="manage-property-bottom">
							<% # The number of views %>
							<span>
								<%= content_tag(:i, "", class:"unhide icon") %>
								<%= listing.ListingViews %> Views
							</span>
							<% # The number of favourites %>
							<span>
								<%= content_tag(:i, "", class:"star icon") %>
								<%= listing.ListingFavourites %> Favourites
							</span>
							<% # The number of comments %>
							<span>
								<%= content_tag(:i, "", class:"comments icon") %>
								<%= listing.ListingComments %> Comments
							</span>
							<% # The time left until expiry %>
							<% # TODO make this get from database %>
							<span>
								<%= content_tag(:i, "", class:"wait icon") %>
								6 Weeks Until Expired
							</span>
						</div>
					</div>
					
					<% # Features and Delete Button block %>
					<div class="three wide right aligned column">
						<% # Property Listing features %>
	 					<p><%= listing.ListingBedrooms %> Bedrooms</p>
	 					<p><%= listing.ListingBathrooms %> Bathrooms</p>
	 					<p><%= listing.ListingParking %> Parking</p>
	 					<p><%= listing.ListingLandSize %>sqm</p>

						<% # Delete Property Listing button %>
						<div class="manage-property-bottom-right">
							<%= link_to sell_path(listing.ListingID), method: :delete, class: "ui small right labeled icon bottom attached button sell-red-button" do  %>
								<%= content_tag(:i, "", class: "trash icon") %>
								Delete
							<% end %>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<% if listing_get_status_object(listing) %>
		<% # If there is a status then we do this %>
		<% # Render the status modal for this property listing %>
		<%= render 'sell/manage_property_status_modal', {
				status_id: listing.ListingStatusID,
				status_object: listing_get_status_object(listing),
				listing_id: listing.ListingID,
				address: "#{listing.ListingAddress}, #{listing.ListingSuburb}, #{listing.ListingState} #{listing.ListingPostCode}"
			} %>
	<% end %>
<% end %>
